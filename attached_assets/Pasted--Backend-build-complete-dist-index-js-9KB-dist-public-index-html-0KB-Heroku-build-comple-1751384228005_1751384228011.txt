âœ… Backend build complete
âœ… dist/index.js (9KB)
âœ… dist/public/index.html (0KB)
ðŸŽ‰ Heroku build completed successfully!
ðŸ“¦ Ready for deployment
~/workspace$ node dist/index.js
file:///home/runner/workspace/dist/index.js:1
"use strict";var E=Object.create;var f=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var w=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var I=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of R(e))!_.call(n,o)&&o!==t&&f(n,o,{get:()=>e[o],enumerable:!(s=v(e,o))||s.enumerable});return n};var P=(n,e,t)=>(t=n!=null?E(w(n)):{},I(e||!n||!n.__esModule?f(t,"default",{value:n,enumerable:!0}):t,n));var l=P(require("express"),1);var h=require("http");var u=class n{API_URL="https://app.for4payments.com.br/api/v1";secret_key;constructor(e){if(!e||e.length<10)throw new Error("Token de autentica\xE7\xE3o inv\xE1lido");this.secret_key=e}static fromEnv(){let e=process.env.FOR4PAYMENTS_SECRET_KEY;if(!e)throw new Error("Chave de API FOR4PAYMENTS_SECRET_KEY n\xE3o configurada");return new n(e)}getHeaders(){return{Authorization:this.secret_key,"Content-Type":"application/json",Accept:"application/json","User-Agent":"For4Payments-NodeJS-SDK/1.0.0","Accept-Language":"pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7"}}validatePaymentData(e){if(!e.name?.trim())throw new Error("Nome \xE9 obrigat\xF3rio");if(!e.email?.trim()||!e.email.includes("@"))throw new Error("Email v\xE1lido \xE9 obrigat\xF3rio");if(!e.cpf?.trim())throw new Error("CPF \xE9 obrigat\xF3rio");if(!e.amount||e.amount<=0)throw new Error("Valor deve ser maior que zero");if(e.cpf.replace(/\D/g,"").length!==11)throw new Error("CPF deve conter exatamente 11 d\xEDgitos");e.description&&(e.description="Kit Bagagem SBT")}async createPixPayment(e){e.description&&(e.description="Kit Bagagem SBT"),this.validatePaymentData(e);try{console.log("\u{1F504} Criando pagamento PIX via For4Payments..."),console.log("\u{1F4CA} Dados do pagamento:",{...e,cpf:e.cpf?.substring(0,3)+"***"});let t=e.cpf.replace(/\D/g,""),s=e.phone?.replace(/\D/g,"")||"11999999999",o={name:e.name.trim(),email:e.email.trim().toLowerCase(),cpf:t,phone:s,paymentMethod:"PIX",amount:e.amount,traceable:!0,items:[{title:"Kit Bagagem SBT",quantity:1,unitPrice:e.amount,tangible:!1}],cep:"01001-000",street:"Rua da S\xE9",number:"1",complement:"",district:"S\xE9",city:"S\xE3o Paulo",state:"SP",utmQuery:"",checkoutUrl:"",referrerUrl:"",externalId:`sbt-${Date.now()}`,postbackUrl:"",fingerPrints:[]};console.log("\u{1F4E4} Enviando request para:",`${this.API_URL}/transaction.purchase`);let r=await fetch(`${this.API_URL}/transaction.purchase`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(o)});console.log("\u{1F4E1} Status da resposta:",r.status);let i=await r.text();if(!r.ok)throw console.error("\u274C Erro na API For4Payments - Status:",r.status),console.error("\u274C Response text:",i),new Error(`Erro da API For4Payments: Status ${r.status} - ${i}`);let a;try{a=JSON.parse(i),console.log("\u2705 PIX criado com sucesso - ID:",a.id)}catch(c){throw console.error("\u274C Erro ao fazer parse da resposta JSON:",c),new Error(`Resposta inv\xE1lida da API: ${i}`)}return this.parsePaymentResponse(a)}catch(t){throw console.error("\u{1F4A5} Erro ao criar pagamento PIX:",t),t}}async extractErrorMessage(e){try{let t=await e.json();return t.message||t.error||"Erro desconhecido da API"}catch{return`Erro HTTP ${e.status}: ${e.statusText}`}}parsePaymentResponse(e){let t=e.pix?.code||e.pixData?.copyPaste||e.pixCode||e.copy_paste||e.code||"",s=e.pix?.qrCode||e.pix?.base64Image||e.qrCode?.imageUrl||e.qr_code_image||e.pixQrCode||"",o=e.expiration||e.expiresAt||new Date(Date.now()+30*60*1e3).toISOString(),r=e.id||e.transactionId||e._id||`txn-${Date.now()}`;return{id:String(r),pix_code:t,pix_qr_code:s,expires_at:o,status:e.status?.toLowerCase()||"pending"}}async checkPaymentStatus(e){try{console.log(`\u{1F50D} Verificando status do pagamento: ${e}`);let t=await fetch(`${this.API_URL}/transaction.getPayment?id=${e}`,{method:"GET",headers:this.getHeaders()});if(console.log("\u{1F4E1} Status da resposta:",t.status),t.status===404)return console.log("\u274C Pagamento n\xE3o encontrado"),this.parseStatusResponse({status:"not_found",found:!1});if(!t.ok){let o=await this.extractErrorMessage(t);throw console.error("\u274C Erro ao verificar status:",o),new Error(`Erro da API: ${o}`)}let s=await t.json();return console.log("\u2705 Status verificado:",s),this.parseStatusResponse(s)}catch(t){return console.error("\u{1F4A5} Erro ao verificar status:",t),this.parseStatusResponse({status:"error",error:t.message,found:!1})}}parseStatusResponse(e){let t={pending:"pending",processing:"pending",waiting:"pending",approved:"completed",completed:"completed",paid:"completed",success:"completed",confirmed:"completed",failed:"failed",error:"failed",cancelled:"cancelled",canceled:"cancelled",expired:"cancelled"},s=e.status?.toLowerCase()||"pending",r={status:t[s]||"pending",original_status:s,found:e.found!==!1,error:e.error};return e.pixCode&&(r.pixCode=e.pixCode),e.pixQrCode&&(r.pixQrCode=e.pixQrCode),e.amount&&(r.amount=e.amount),e.paidAt&&(r.paidAt=e.paidAt),e.expiresAt&&(r.expiresAt=e.expiresAt),r}async getPaymentSummary(e){let t=await this.checkPaymentStatus(e);return{id:e,is_paid:t.status==="completed",is_pending:t.status==="pending",is_failed:t.status==="failed",status:t.status,original_status:t.original_status,found:t.found,error:t.error}}};async function y(n){return n.get("/api/passengers",(t,s)=>{try{let o=[],r={nome:"JO\xC3O SILVA SANTOS",email:"joao@email.com",telefone:"(11) 99999-9999",cep:"01310-100"},i=[{nome:"MARIA SILVA SANTOS",idade:12,telefone:"(11) 88888-8888"}];r.nome&&o.push({name:r.nome,type:"Respons\xE1vel",isMain:!0}),i.forEach((a,c)=>{a.nome&&o.push({name:a.nome,type:`Candidato ${c+1}`,isMain:!1})}),s.json({passengers:o,flightInfo:{selectedDate:"2025-07-26",selectedFlightOption:"1",nearestAirport:{code:"GRU",city:"S\xE3o Paulo"}}})}catch{s.status(500).json({error:"Erro ao recuperar dados dos passageiros"})}}),n.post("/api/pix/create",async(t,s)=>{try{console.log("=== IN\xCDCIO CRIA\xC7\xC3O PIX ==="),console.log("Body recebido:",JSON.stringify(t.body,null,2));let{name:o,email:r,cpf:i,amount:a,description:c,phone:x}=t.body;if(!o||!r||!i||!a)return console.log("\u274C Dados obrigat\xF3rios ausentes"),s.status(400).json({success:!1,error:"Dados obrigat\xF3rios: name, email, cpf, amount"});console.log("\u{1F680} Iniciando cria\xE7\xE3o de pagamento...");let S=u.fromEnv();console.log("\u{1F511} API inicializada, criando pagamento...");let d=await S.createPixPayment({name:o,email:r,cpf:i,amount:a,description:c,phone:x});console.log("\u2705 PIX criado com sucesso!"),console.log("ID:",d.id),console.log("PIX Code:",d.pix_code?"PRESENTE":"AUSENTE");let g={success:!0,payment:{id:d.id,pix_code:d.pix_code,pix_qr_code:d.pix_qr_code,expires_at:d.expires_at,status:d.status,formatted_amount:`R$ ${(a/100).toFixed(2).replace(".",",")}`}};console.log("\u{1F4E4} Enviando resposta:",JSON.stringify(g,null,2)),s.json(g)}catch(o){console.error("\u274C ERRO COMPLETO na cria\xE7\xE3o PIX:"),console.error("Tipo:",o.constructor.name),console.error("Mensagem:",o.message),console.error("Stack:",o.stack),s.status(500).json({success:!1,error:o.message||"Erro interno do servidor",type:o.constructor.name})}}),n.get("/api/pix/status/:payment_id",async(t,s)=>{try{let{payment_id:o}=t.params;console.log("\u{1F50D} Verificando status PIX:",o);let i=await u.fromEnv().getPaymentSummary(o);console.log("\u{1F4CA} Status PIX:",i),s.json(i)}catch(o){console.error("\u274C Erro ao verificar status PIX:",o),s.status(500).json({error:o.message||"Erro interno do servidor"})}}),(0,h.createServer)(n)}var m=P(require("path"),1),p=(0,l.default)();p.use(l.default.json());p.use(l.default.urlencoded({extended:!1}));p.use("/attached_assets",l.default.static("attached_assets"));p.use((n,e,t)=>{let s=Date.now(),o=n.path,r,i=e.json;e.json=function(a,...c){return r=a,i.apply(e,[a,...c])},e.on("finish",()=>{let a=Date.now()-s;if(o.startsWith("/api")){let c=`${n.method} ${o} ${e.statusCode} in ${a}ms`;r&&(c+=` :: ${JSON.stringify(r)}`),console.log(c)}}),t()});(async()=>{let n=await y(p),e=m.default.resolve(process.cwd(),"dist","public");console.log(`Serving static files from: ${e}`),require("fs").existsSync(e)||(console.error(`Static files directory not found: ${e}`),process.exit(1)),p.use(l.default.static(e)),p.get("*",(s,o)=>{if(s.path.startsWith("/api"))return o.status(404).json({message:"API route not found"});let r=m.default.join(e,"index.html");console.log(`Serving SPA fallback: ${r}`),o.sendFile(r)}),p.use((s,o,r,i)=>{let a=s.status||s.statusCode||500,c=s.message||"Internal Server Error";console.error(`Error ${a}: ${c}`),r.status(a).json({message:c})});let t=parseInt(process.env.PORT||"5000",10);n.listen(t,"0.0.0.0",()=>{console.log(`\u{1F680} Server running on port ${t}`),console.log(`\u{1F4C1} Static files served from: ${e}`)})})();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ^

ReferenceError: require is not defined in ES module scope, you can use import instead
This file is being treated as an ES module because it has a '.js' file extension and '/home/runner/workspace/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
    at file:///home/runner/workspace/dist/index.js:1:479
    at ModuleJob.run (node:internal/modules/esm/module_job:234:25)
    at async ModuleLoader.import (node:internal/modules/esm/loader:473:24)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:122:5)

Node.js v20.18.1
~/workspace$ 